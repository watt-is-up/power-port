name: CI/CD

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore

    - name: Run Tests
      run: dotnet test --no-build --verbosity normal

  build-and-push:
    needs: build-test
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker images
      run: |
        IMAGE_PREFIX=ghcr.io/${{ github.repository_owner }}
        
        docker build -t $IMAGE_PREFIX/user-service:latest ./src/UserService
        docker push $IMAGE_PREFIX/user-service:latest
        
        docker build -t $IMAGE_PREFIX/station-service:latest ./src/StationService
        docker push $IMAGE_PREFIX/station-service:latest
        
        docker build -t $IMAGE_PREFIX/billing-service:latest ./src/BillingService
        docker push $IMAGE_PREFIX/billing-service:latest

        docker build -t $IMAGE_PREFIX/provider-service:latest ./src/ProviderService
        docker push $IMAGE_PREFIX/provider-service:latest

        docker build -t $IMAGE_PREFIX/data-tracking-service:latest ./src/DataTrackingService
        docker push $IMAGE_PREFIX/data-tracking-service:latest
        
        docker build -t $IMAGE_PREFIX/reviews-service:latest ./src/ReviewsService
        docker push $IMAGE_PREFIX/reviews-service:latest

  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: build-and-push

  #   steps:
  #   - uses: actions/checkout@v4

  #   - name: Set kubeconfig
  #     run: |
  #       mkdir ~/.kube
  #       echo "${{ secrets.KUBECONFIG_CONTENT }}" > ~/.kube/config

  #   - name: Deploy to Kubernetes
  #     run: |
  #       kubectl apply -f deploy/k8s/
